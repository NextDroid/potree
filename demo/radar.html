<!DOCTYPE html>
<html lang="en">

<style>
.slidecontainer {
    width: 15%;
}

.slider {
    -webkit-appearance: none;
    width: 100%;
    height: 25px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}
</style>

<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/perfect-scrollbar/css/perfect-scrollbar.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
  <script src="radarloader.js"></script>
  <script src="rtkloader.js"></script>
</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../libs/three.js/build/three.min.js"></script>
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>
  <script src="../libs/other/OBJLoader.js"></script>


	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->

	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div class="slidecontainer">
			<input type="range" min="1" max="100" value=50 step="0.01" class="slider" id="myRange">
			<p> Value: <span id="demo">0.0000</span> seconds</p>
			<input type="button" value="Play" id="playbutton">
			<input type="button" value="Pause" id="pausebutton">
		</div>
		<div id="potree_render_area"></div>
		<div id="potree_sidebar_container"> </div>
	</div>


  <script type="x-shader/x-vertex" id="vertexshader">

      attribute float alpha;
      attribute float gpsTime;

      uniform float minGpsTime;
      uniform float maxGpsTime;

      varying float vAlpha;

      void main() {

        if (minGpsTime <= gpsTime && gpsTime <= maxGpsTime) {
          vAlpha = 1.0;
        } else {
          vAlpha = 0.0;
        }


        // if (currentGpsTime > 10.0) {
        // } else {
        //   vAlpha = 1.0
        // }

          vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

          gl_PointSize = 8.0;

          gl_Position = projectionMatrix * mvPosition;

      }

  </script>

  <script type="x-shader/x-fragment" id="fragmentshader">

      uniform vec3 color;

      varying float vAlpha;

      void main() {

          gl_FragColor = vec4( color, vAlpha );

      }

  </script>





	<script>

		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(1*1000*1000);
		document.title = "";
		viewer.setEDLEnabled(false);
		viewer.setBackground("gradient"); // ["skybox", "gradient", "black", "white"];
		viewer.setDescription(``);
		viewer.loadSettingsFromURL();

		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			viewer.toggleSidebar();
      // viewer.scene.view.position.set(300198.109, 4701144.537, 349.871);
      // viewer.scene.view.lookAt(new THREE.Vector3(299900.954, 4701576.919, 66.197));
		});


    // Load Radar:
    loadRadar((geometry) => {

      // uniforms
      uniforms = {

          color: { value: new THREE.Color( 0xff00ff ) },
          minGpsTime: {value: 0.0 },
          maxGpsTime: {value: 110.0 }


      };

      // point cloud material
      var shaderMaterial = new THREE.ShaderMaterial( {

          uniforms:       uniforms,
          vertexShader:   document.getElementById( 'vertexshader' ).textContent,
          fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
          transparent:    true

      });

      var material = new THREE.PointsMaterial( {size:1.0} );
      var mesh = new THREE.Points(geometry, shaderMaterial);
      mesh.name = "radar";
      // debugger; //radar tracks added?
      viewer.scene.scene.add(mesh);


    });

    // Load RTK:
    loadRtk((pos) => {
      path = pos.map(v => new THREE.Vector3(...v));
      console.log(path);

      let animationPath = new Potree.AnimationPath(path);
      animationPath.closed = false;

      { // render the path
        let geometry = animationPath.getGeometry();
        let material = new THREE.LineBasicMaterial();
        let line = new THREE.Line(geometry, material, {closed: animationPath.closed});
        viewer.scene.scene.add(line);
        console.log("Rendered Path");
      }


      // CREATE VEHICLE OBJECT:
      let manager = new THREE.LoadingManager();
      manager.onProgress = function ( item, loaded, total ) {
        console.log( item, loaded, total );
      };
      let textureLoader = new THREE.TextureLoader( manager );
      let texture = textureLoader.load(`${Potree.resourcePath}/models/bodybkgd.JPG`);
      let onProgress = function ( xhr ) {
        if ( xhr.lengthComputable ) {
          let percentComplete = xhr.loaded / xhr.total * 100;
          console.log( Math.round(percentComplete, 2) + '% downloaded' );
        }
      };
      texture.wrapS = THREE.RepeatWrapping;
      texture.wrapT = THREE.RepeatWrapping;

      var geometry = new THREE.SphereGeometry( 100, 32, 32 );
      var material = new THREE.MeshNormalMaterial( {side: THREE.DoubleSide, map: texture, opacity: 0.4,transparent:true});
      var sphere = new THREE.Mesh( geometry, material );
      sphere.position = new THREE.Vector3(...pos[0]);
      console.log(sphere);

      // viewer.scene.scene.add( sphere );

      console.log("Sphere added");


      { // Load Textured bunny from obj


        let onError = function ( xhr ) {};
        let loader = new THREE.OBJLoader( manager );
        loader.load(`${Potree.resourcePath}/models/1967-shelby-ford-mustang.obj`, function ( object ) {
          object.traverse( function ( child ) {
            if ( child instanceof THREE.Mesh ) {
              child.material.map = texture;
            }
          } );

          object.name = "bunny";
          object.position.set(...pos[0]);
          object.scale.multiplyScalar(.75);
          // object.rotation.set(Math.PI / 2, 1*Math.PI/2., Math.PI/2.0)

          viewer.scene.scene.add( object );

        }, onProgress, onError );
      }






      // ANIMATION:
      { // create Animation Path & make light follow it


        {// ANIMATION + SLIDER LOGIC:
          let slider = document.getElementById("myRange");
          let output = document.getElementById("demo");
          output.innerHTML = slider.value;

          // Animate from beginning to end with a speed of 100 meters per second
          let start = 0;
          let end = Infinity;
          let speed = 100;
          let animation = animationPath.animate(start, end, speed, t => {
            animation.repeat = true;

            // t is a value between 0 and 1.
            // use getPoint(t) to map from t to the position on the animation path
            let point = animation.getPoint(t);
            sphere.position.copy(point);
            var bunny = viewer.scene.scene.getObjectByName("bunny");
            bunny.position.copy(point);

            var up = new THREE.Vector3(0, 0, -1);
            var axis = new THREE.Vector3();
            console.log(animation);
            // debugger;
            tangent = animation.path.spline.getTangentAt(t).normalize();
            axis.crossVectors(up, tangent).normalize();
            var radians = Math.acos(up.dot(tangent));
            bunny.quaternion.setFromAxisAngle(axis, radians);


            slider.value = 100*t;
            var time = (viewer.scene.pointclouds[0].pcoGeometry.nodes.r.gpsTime.range*t);
            output.innerHTML = time.toFixed(4);

            // Set Time in Material:
            viewer.scene.pointclouds[0].material.uniforms.timeVal.value = t; // TODO not used I think
            // debugger; //update radar material here

            // Create GPS Time Clipping Event:
            var minGpsTime = time - 1.0;
            var maxGpsTime = time + 0.0;
            viewer.setFilterGPSTimeRange(minGpsTime, maxGpsTime);
            viewer.setFilterGPSTimeExtent(minGpsTime-10, maxGpsTime+10);

            var radar = viewer.scene.scene.getObjectByName("radar")
            radar.material.uniforms.minGpsTime.value = minGpsTime;
            radar.material.uniforms.maxGpsTime.value = maxGpsTime;
            console.log(radar);


            let camera = viewer.scene.getActiveCamera();
            let lag = 2.0; // seconds
            let lagTime = Math.max(0, (time-lag)/viewer.scene.pointclouds[0].pcoGeometry.nodes.r.gpsTime.range);
            let camPoint = animation.getPoint(lagTime);  // Get point with 1 second lag
            camPoint.z += 30;
            camera.position.copy(camPoint);
            camera.lookAt(sphere.position);


          });
          window.animation = animation;

          // Play/Pause Button Functions:
          let playbutton = document.getElementById("playbutton");
          let pausebutton = document.getElementById("pausebutton");
          pausebutton.addEventListener("click", () => {animation.pause();});
          playbutton.addEventListener("click", () => {animation.resume();});
          slider.addEventListener("input", () => {

            $("#pausebutton").click();

            var val = slider.value/100.0;
            var time = 0;
            if (viewer.scene.pointclouds[0].pcoGeometry.nodes.r.gpsTime) {
              time = (viewer.scene.pointclouds[0].pcoGeometry.nodes.r.gpsTime.range*slider.value/100);
            } else {
              time = -1;
            }
            output.innerHTML = time.toFixed(4);

            animation.t = val;
            let point = animation.getPoint(animation.t);
            sphere.position.copy(point);
            viewer.scene.pointclouds[0].material.uniforms.timeVal.value = val;

            // Create GPS Time Clipping Event:
            var minGpsTime = time - 10.0;
            var maxGpsTime = time + 0.0;
            viewer.setFilterGPSTimeRange(minGpsTime, maxGpsTime);
            viewer.setFilterGPSTimeExtent(minGpsTime-10, maxGpsTime+10);

            var radar = viewer.scene.scene.getObjectByName("radar")
            radar.material.uniforms.minGpsTime.value = minGpsTime;
            radar.material.uniforms.maxGpsTime.value = maxGpsTime;
            console.log(radar);

          });
        }

        window.animationPath = animationPath;
      }

    });




		// Potree.loadPointCloud("../pointclouds/fullpointcloud-time-mini/cloud.js", "fullpointcloud-time-mini", e => {
		// Potree.loadPointCloud("../pointclouds/basemap-time/cloud.js", "basemap-time", e => {
		Potree.loadPointCloud("../pointclouds/basemap-demo/cloud.js", "basemap-demo", e => {

			let pointcloud = e.pointcloud;
			let material = pointcloud.material;
			console.log(pointcloud.pcoGeometry.nodes.r.gpsTime);
			viewer.scene.addPointCloud(pointcloud);
			material.pointColorType = Potree.PointColorType.RGB; // any Potree.PointColorType.XXXX
			material.size = 1;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			material.shape = Potree.PointShape.SQUARE;

      viewer.scene.view.position.set(300198.109, 4701144.537, 349.871);
      viewer.scene.view.lookAt(new THREE.Vector3(299900.954, 4701576.919, 66.197));
      viewer.toggleNavigationCube();

			console.log("SET TIMEVAL IN MATERIAL HERE");
			console.log(material.uniforms.timeVal);

		});




		</script>


  </body>
</html>
