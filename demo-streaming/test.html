<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Test Streamer Javascript Functions</title>

</head>

<body>
  <script src="../libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="../libs/spectrum/spectrum.js"></script>
  <script src="../libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
  <script src="../libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="../libs/three.js/build/three.js"></script>
  <script src="../libs/other/BinaryHeap.js"></script>
  <script src="../libs/tween/tween.min.js"></script>
  <script src="../libs/d3/d3.js"></script>
  <script src="../libs/proj4/proj4.js"></script>
  <script src="../libs/openlayers3/ol.js"></script>
  <script src="../libs/i18next/i18next.js"></script>
  <script src="../libs/jstree/jstree.js"></script>
  <script src="../build/potree/potree.js"></script>
  <script src="../libs/plasio/js/laslaz.js"></script>
  <!-- <script src="streamer.js"></script> -->

  <div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
    <div id="potree_render_area"></div>
    <div id="potree_sidebar_container"> </div>
  </div>
  <script>
    // Initialize Viewer:
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

    viewer.setEDLEnabled(true);
    viewer.setFOV(60);
    viewer.setPointBudget(1*1000*1000);
    viewer.loadSettingsFromURL();

    viewer.setDescription("Example page to test out streaming point clouds into Potree using Three.js");

    viewer.loadGUI(() => {
      viewer.setLanguage('en');
      // viewer.setBackground('white');
      $("#menu_tools").next().show();
      $("#menu_scene").next().show();
      // viewer.toggleSidebar();
    });

    // Initializations:
    var viewerOffset = 100;
    var bboxMax;
    var geoms = [];
    var mesh5M, mesh18M;
    var waitOnCapacity = 2;
    var waitOn = waitOnCapacity;

    // Performance Timing:
    var t0 = performance.now();
    var t1 = 0;

  </script>


  <script type="x-shader/x-vertex" id="vertexshader">

      attribute float alpha;
      attribute float gpsTime;

      uniform float minGpsTime;
      uniform float maxGpsTime;

      varying float vAlpha;

      void main() {
        if (minGpsTime <= gpsTime && gpsTime <= maxGpsTime) {
          vAlpha = 1.0;
        } else {
          vAlpha = 0.0;
        }
        vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
        gl_PointSize = 8.0;
        gl_Position = projectionMatrix * mvPosition;
      }
  </script>

  <script type="x-shader/x-fragment" id="fragmentshader">
      uniform vec3 color;
      varying float vAlpha;

      void main() {
          gl_FragColor = vec4( color, vAlpha );
      }
  </script>

  <!-- <script>

  // Create Settings:
  var settings = {
    serverUrl: "http://localhost",
    port: "4321",
    headerFilename: "basemap-demo.xyz.bin.header",
    filename: "basemap-demo.xyz.bin",
    maxMemMB: 100,
    TA: 10
  }

  // var renderer = new THREE.WebGLRenderer();
	// renderer.setSize( 800, 600 );
	// document.body.appendChild( renderer.domElement );

	var scene = new THREE.Scene();

	var camera = new THREE.PerspectiveCamera(
		35,			// Field of view
		800 / 600,		// Aspect ratio
		0.1,			// Near plane
		10000			// Far plane
	);
  viewer.scene.view.position.set(300319.651061, 4701462.52818, 346.296678213);
  // viewer.scene.view.lookAt(cloudGeometry.boundingSphere.center);

  // Create Geometry and Mesh:
  var cloudGeometry = new THREE.BufferGeometry();
  var material = new THREE.ShaderMaterial({
    size: 0.05, // 0.005
    // vertexColors: THREE.VertexColors,	// NOTE using THREE.VertexColors allows individual points to have their own color
    vertexShader:   document.getElementById( 'vertexshader' ).textContent,
    fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
    transparent:    true,
    uniforms: {
      color: { value: new THREE.Color( 0x003DFF ) },
      minGpsTime: {value: 0.0 },
      maxGpsTime: {value: 0.0 },
      // initialTime: {value: t_init}
    }
  });
  var cloudMesh = new THREE.Points(cloudGeometry, material);
  cloudMesh.timeRange = {tmin: 0, tmax: 0};
  cloudMesh.name = "cloud";
  viewer.scene.scene.add(cloudMesh);


  // Send Header Request:
  sendHeaderRequest(settings.serverUrl + ":" + settings.port + "/args/header/" + settings.headerFilename, (e) => {
    console.log(e);

    var header = e.data;
    streamFromTime(0, header, settings);
  });





  </script> -->
	<script src="bower_components/cbuffer/cbuffer.js"></script>
	<script src="bufferFunctions.js"></script>
	<!-- <script src="test.js"></script> -->
	<script>

		var worker = new Worker('test.js');
		console.log("Running Pump Tests");
		for (let ii=0; ii<20; ii++) {
			worker.postMessage("start");
		}
	</script>


</body>
</html>
