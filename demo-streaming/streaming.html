<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/perfect-scrollbar/css/perfect-scrollbar.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
	<link rel="stylesheet" type="text/css" href="../common/playbar.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../libs/three.js/build/three.js"></script>
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>
	<!-- <script src="../node_modules/papaparse/papaparse.min.js"></script> -->
	<!-- <script src="../bower_components/cbuffer/cbuffer.js"></script> -->
	<script src="executionLoop.js"></script>
	<script src="rtkloader.js"></script>
	<script src="radarloader.js"></script>
	<script src="../common/playbar.js"></script>
	<script src="../libs/other/OBJLoader.js"></script>
	<script src="../libs/three.js/examples/js/loaders/PCDLoader.js"></script>

	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->

	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area"></div>
		<div id="potree_sidebar_container"> </div>
	</div>


  <script>
    // Initialize Viewer:
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

    viewer.setEDLEnabled(true);
    viewer.setFOV(60);
    viewer.setPointBudget(1*1000*1000);
    viewer.loadSettingsFromURL();

    viewer.setDescription("Example page to test out streaming point clouds into Potree using Three.js");

    viewer.loadGUI(() => {
      viewer.setLanguage('en');
			viewer.setBackground('white');
      $("#menu_tools").next().show();
      $("#menu_scene").next().show();
      // viewer.toggleSidebar();
    });

		// Initializations:
		var viewerOffset = 100;
		var bboxMax;
		var geoms = [];
		var mesh5M, mesh18M;
		var waitOnCapacity = 2;
		var waitOn = waitOnCapacity;
		var loader = new THREE.PCDLoader();

		// Performance Timing:
		var t0 = performance.now();
		var t1 = 0;

  </script>


	<script>
	function createPointMesh(geom) {
		var material = new THREE.PointsMaterial( {size: 0.005, vertexColors: THREE.VertexColors} ); // NOTE using THREE.VertexColors allows individual points to have their own color
		var mesh = new THREE.Points(geom, material);
		mesh.name = "cloud";
		return mesh;
	}

	function addPointMesh(mesh) {
		// Add to scene:
		console.log(mesh);
		viewer.scene.scene.add(mesh);

		// Set Viewer Position:
		mesh.geometry.computeBoundingBox();
		bboxMax = mesh.geometry.boundingBox.max;
		viewer.scene.view.position.set(bboxMax.x+viewerOffset, bboxMax.y+viewerOffset, bboxMax.z+viewerOffset);
		viewer.scene.view.lookAt(mesh.geometry.boundingSphere.center);
		viewer.toggleNavigationCube();
	}

	function loadPCD(loader, filepath, tag) {
		loader.load(filepath,
		onLoad = function(geom) {

			console.log('onLoad-18M');
			console.log(geom);
			geoms.push(geom.clone());

			var mesh = createPointMesh(geom);
			var e = new Event('loaded-'+tag);
			e.detail = mesh;
			window.dispatchEvent(e);

			// Log Performance Timing:
			var t1 = performance.now();
			console.log("Done");
			console.log("Performance: " + (t1-t0)/1000 + " seconds");
		},
		onProgress = function(results) {
			console.log('onProgress-'+tag);

			// Log Performance Timing:
			console.log("Loaded " + results.loaded + " bytes -- " + results.loaded + "/" + results.total + " (" + 100*results.loaded/results.total + "%)" );
			t1 = performance.now();
			console.log("Performance: " + (t1-t0)/1000 + " seconds");
		},
		onError = function(e) {
			console.log('onError'+tag);
			console.log(e);
		}
	);
	}

	function executeAfterLoaded(mesh) {
		mainLoopCircular(mesh);
		return;
		// waitOn--;
		//  if ((waitOnCapacity-waitOn) == 1) {
		// 	 console.log('First point cloud loaded');
		// 	 addPointMesh(mesh);
		//  } else if (waitOn == 0) {
		// 	console.log("All clouds loaded!");
		// 	// debugger; // remove attribute --> how to remove attribute without losing it
		// 	// mainLoopSwap();
		//
		// }
	}
	</script>


  <script>

	var t0 = performance.now();

	// Time RTK Loader:
	loadRtk("rtkdata.csv", false, (pos, rot, t_init) => {

		// path = pos.map(v => new THREE.Vector3(...v));
		// orientations = rot.map(v => new THREE.Vector3(...v));
		//
		// let animationPath = new Potree.AnimationPath(path);
		// animationPath.closed = false;
		//
		// // CREATE VEHICLE OBJECT:
		// // NOTE for Mustang: {texture: models/bodybkgd.JPG, mesh: models/1967-shelby-ford-mustang.obj}
		// // NOTE for Volt: {texture: models/Chevy_Volt_Segmented/Chevrolet_Volt_v1_exterior.png, mesh: resources/models/Chevy_Volt_Segmented/Chevy_Volt_2016.obj}
		// let manager = new THREE.LoadingManager();
		// manager.onProgress = function ( item, loaded, total ) {
		// 	console.log( item, loaded, total );
		// };
		// let textureLoader = new THREE.TextureLoader( manager );
		// let texture = textureLoader.load(`${Potree.resourcePath}/models/bodybkgd.JPG`);
		// let onProgress = function ( xhr ) {
		// 	if ( xhr.lengthComputable ) {
		// 		let percentComplete = xhr.loaded / xhr.total * 100;
		// 		console.log( Math.round(percentComplete, 2) + '% downloaded' );
		// 	}
		// };
		// texture.wrapS = THREE.RepeatWrapping;
		// texture.wrapT = THREE.RepeatWrapping;
		//
		//
		// { // Load Textured bunny from obj
		// 	let onError = function ( xhr ) {};
		// 	let loader = new THREE.OBJLoader( manager );
		// 	loader.load(`${Potree.resourcePath}/models/1967-shelby-ford-mustang.obj`, function ( object ) {
		// 		object.traverse( function ( child ) {
		// 			if ( child instanceof THREE.Mesh ) {
		// 				child.material.map = texture;
		// 			}
		// 		} );
		//
		// 		object.name = "bunny";
		// 		object.position.set(...pos[0]);
		// 		object.scale.multiplyScalar(.5);
		// 		object.orientations = orientations;
		// 		object.rotation.set(Math.PI / 2, 0*Math.PI/2., 0*Math.PI/2.0)
		//
		// 		viewer.scene.scene.add( object );
		//
		// 	}, onProgress, onError );
		// }

		console.log("Rtk data loaded");
		var dtMillis = performance.now() - t0;
		console.log("loaded 10 minutes of rtk data in " + (dtMillis/1000.) + " seconds");
	});


	// Time Radar Loader:
	loadRadar("../demo/csv/radar_tracks_demo.csv", false, (geometry, t_init) => {

		// var material = new THREE.PointsMaterial( {size:1.0} );
		// var mesh = new THREE.Points(geometry, material);
		// mesh.name = "radar";
		// // debugger; //radar tracks added?
		// viewer.scene.scene.add(mesh);

		console.log("Radar data loaded");
		var dtMillis = performance.now() - t0;
		console.log("loaded 10 minutes of radar data in " + (dtMillis/1000.) + " seconds");
	});


	// Load Point Clouds:
	window.addEventListener('loaded-cloud18M', (e) =>{
		console.log("loaded cloud18M");
		mesh18M = e.detail;
		console.log(mesh18M);
		executeAfterLoaded(mesh18M);
	});

	window.addEventListener('loaded-cloud5M', (e) => {
		console.log("loaded cloud5M");
		mesh5M = e.detail;
		console.log(mesh5M);
		executeAfterLoaded(mesh5M);
	});

	loadPCD(loader, "../clouds/cloud-18M.pcd", "cloud18M");
	loadPCD(loader, "../clouds/cloud-18M.pcd", "cloud18M");
	loadPCD(loader, "../clouds/cloud-18M.pcd", "cloud18M");
	// loadPCD(loader, "../clouds/cloud-5M.pcd", "cloud5M");

  </script>



</body>
</html>
